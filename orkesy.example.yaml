version: "1"
name: "my-app"

services:
  # Database service
  postgres:
    name: PostgreSQL
    kind: database
    command: ["postgres", "-c", "listen_addresses=*"]
    port: 5432
    env:
      POSTGRES_PASSWORD: devpass
      POSTGRES_DB: myapp
    health_check:
      type: tcp
      interval_ms: 5000
    autostart: true
    description: "Primary database"

  # Cache service
  redis:
    name: Redis
    kind: cache
    command: ["redis-server", "--port", "6379"]
    port: 6379
    health_check:
      type: tcp
      interval_ms: 3000
    autostart: true

  # API service
  api:
    name: "API Server"
    kind: http
    command: ["cargo", "run", "--release"]
    cwd: ./api
    port: 8000
    env:
      DATABASE_URL: "postgres://localhost:5432/myapp"
      REDIS_URL: "redis://localhost:6379"
      RUST_LOG: "info"
    depends_on:
      - postgres
      - redis
    health_check:
      type: http
      path: /health
      interval_ms: 5000
      timeout_ms: 2000
    autostart: true
    restart: on-failure
    description: "REST API server"

  # Background worker
  worker:
    name: "Background Worker"
    kind: worker
    command: ["cargo", "run", "--bin", "worker"]
    cwd: ./worker
    env:
      DATABASE_URL: "postgres://localhost:5432/myapp"
      REDIS_URL: "redis://localhost:6379"
    depends_on:
      - postgres
      - redis
    autostart: false
    restart: on-failure
    description: "Async job processor"

  # Frontend dev server
  frontend:
    name: "Frontend"
    kind: frontend
    command: ["npm", "run", "dev"]
    cwd: ./frontend
    port: 3000
    env:
      VITE_API_URL: "http://localhost:8000"
    depends_on:
      - api
    health_check:
      type: http
      path: /
      interval_ms: 5000
    autostart: true
    description: "Vite dev server"
